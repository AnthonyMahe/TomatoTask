# Implementation Plan: TomatoTask - Pomodoro Timer with TodoList

**Branch**: `claude/tomatotask-setup-011CV5fqQiDPnEwd4zk32iBp` | **Date**: 2025-11-13 | **Spec**: [tomatotask-core.md](./tomatotask-core.md)

## Summary

TomatoTask is a desktop productivity application combining Pomodoro time management with integrated task tracking. Built on Tauri 2 + Svelte 5 architecture, it provides a native desktop experience with SQLite persistence, multi-language support, and system tray integration. The application follows clean architecture principles with strict separation between UI (Svelte), business logic (TypeScript stores/services), and data layer (Rust/Tauri commands).

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode) + Rust 1.75+ (latest stable)
**Primary Dependencies**:
- Frontend: Svelte 5 (Runes API), TailwindCSS 3.x, Shadcn-svelte, svelte-i18n
- Backend: Tauri 2, rusqlite, serde, tauri-plugin-notification, tauri-plugin-system-tray
**Storage**: SQLite 3.x (via rusqlite) - local file-based database
**Testing**: Vitest (unit), Playwright (E2E), cargo test (Rust backend)
**Target Platform**: Cross-platform desktop (Windows 10+, macOS 10.15+, Linux Ubuntu 20.04+)
**Project Type**: Desktop application (Tauri hybrid architecture)
**Performance Goals**:
- Startup < 2s, View transitions < 100ms, DB queries < 50ms
- Timer precision ±100ms, Memory usage < 150MB
- Bundle size < 5MB
**Constraints**:
- All code comments MUST be in French
- Strict DRY principle enforcement
- WCAG 2.1 AA compliance required
- No network dependencies (fully offline)
**Scale/Scope**:
- Support 10,000+ tasks without degradation
- 5 languages (EN, FR, ES, IT, DE)
- 50+ Svelte components
- ~15 Tauri commands

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **Clean Architecture & DRY**: Architecture separates UI/Logic/Data layers clearly
✅ **Code Comments in French**: All inline comments, docs, and TODOs in French
✅ **Type Safety**: TypeScript strict mode + Rust Clippy with zero warnings
✅ **Performance Optimization**: Targets defined (2s startup, 100ms transitions, 50ms queries)
✅ **Multi-Language Support**: i18n framework required, 5 languages
✅ **Accessibility**: WCAG 2.1 AA, keyboard navigation, ARIA labels required
✅ **Modular Components**: Shadcn-svelte patterns, composable components < 300 lines
✅ **Security**: Input validation both sides, prepared statements only
✅ **Testing**: 70% coverage minimum, E2E for critical flows
✅ **Git Standards**: Conventional commits, atomic changes, frequent commits

**No constitutional violations - proceed with implementation.**

## Project Structure

### Documentation (this feature)

```text
.specify/
├── memory/
│   └── constitution.md       # Project constitution v1.0.0
├── specs/
│   └── tomatotask-core.md    # Functional specifications
├── plans/
│   └── implementation-plan.md # This file
└── tasks/
    └── tasks.md              # Generated by /speckit.tasks (pending)
```

### Source Code (based on Tauri2-Svelte5-Shadcn boilerplate)

```text
src/                          # Frontend source
├── lib/
│   ├── components/           # Svelte components
│   │   ├── ui/               # Shadcn-svelte base components
│   │   │   ├── button/
│   │   │   ├── dialog/
│   │   │   ├── input/
│   │   │   └── ...
│   │   ├── timer/            # Timer-specific components
│   │   │   ├── PomodoroTimer.svelte
│   │   │   ├── TimerControls.svelte
│   │   │   └── TimerDisplay.svelte
│   │   ├── tasks/            # Task management components
│   │   │   ├── TaskList.svelte
│   │   │   ├── TaskCard.svelte
│   │   │   ├── TaskForm.svelte
│   │   │   └── TaskFilters.svelte
│   │   ├── summary/          # Analytics/summary components
│   │   │   ├── DailySummary.svelte
│   │   │   ├── WeeklyChart.svelte
│   │   │   └── MonthlyView.svelte
│   │   ├── settings/         # Settings components
│   │   │   ├── SettingsPanel.svelte
│   │   │   ├── ThemeToggle.svelte
│   │   │   └── LanguageSelector.svelte
│   │   └── layout/           # Layout components
│   │       ├── Sidebar.svelte
│   │       └── Header.svelte
│   ├── stores/               # Svelte stores (state management)
│   │   ├── timer.ts          # Timer state (current session, elapsed time)
│   │   ├── tasks.ts          # Tasks state (list, filters, selected)
│   │   ├── settings.ts       # User settings state
│   │   ├── projects.ts       # Projects state
│   │   └── summary.ts        # Summary/analytics state
│   ├── services/             # Business logic services
│   │   ├── timer-service.ts  # Timer logic (start, pause, complete)
│   │   ├── task-service.ts   # Task CRUD operations
│   │   ├── notification-service.ts # Notification handling
│   │   └── i18n-service.ts   # Internationalization logic
│   ├── utils/                # Utility functions
│   │   ├── time-formatter.ts # Time formatting utilities
│   │   ├── validators.ts     # Input validation
│   │   └── keyboard.ts       # Keyboard shortcut handling
│   ├── types/                # TypeScript type definitions
│   │   ├── task.ts           # Task, Project types
│   │   ├── timer.ts          # Timer, PomodoroSession types
│   │   └── settings.ts       # Settings types
│   └── i18n/                 # Translation files
│       ├── en.json
│       ├── fr.json
│       ├── es.json
│       ├── it.json
│       └── de.json
├── routes/                   # SvelteKit routes (if using routing)
│   ├── +page.svelte          # Main timer view
│   ├── tasks/
│   │   └── +page.svelte      # Tasks view
│   ├── summary/
│   │   └── +page.svelte      # Summary view
│   └── settings/
│       └── +page.svelte      # Settings view
├── App.svelte                # Root component
└── main.ts                   # Frontend entry point

src-tauri/                    # Rust backend
├── src/
│   ├── main.rs               # Tauri app entry point
│   ├── commands/             # Tauri commands (frontend-backend interface)
│   │   ├── mod.rs
│   │   ├── tasks.rs          # Task-related commands
│   │   ├── timer.rs          # Timer-related commands
│   │   ├── projects.rs       # Project commands
│   │   ├── settings.rs       # Settings commands
│   │   └── summary.rs        # Summary/analytics commands
│   ├── db/                   # Database layer
│   │   ├── mod.rs
│   │   ├── connection.rs     # SQLite connection management
│   │   ├── migrations.rs     # Database schema migrations
│   │   ├── models.rs         # Rust data models
│   │   └── queries/          # Prepared SQL queries
│   │       ├── tasks.rs
│   │       ├── projects.rs
│   │       ├── sessions.rs
│   │       └── settings.rs
│   ├── services/             # Backend business logic
│   │   ├── mod.rs
│   │   └── notification.rs   # System notification service
│   └── utils/                # Backend utilities
│       ├── mod.rs
│       └── error.rs          # Error handling
├── Cargo.toml                # Rust dependencies
└── tauri.conf.json           # Tauri configuration

tests/                        # Test files
├── unit/                     # Unit tests
│   ├── timer.test.ts
│   ├── tasks.test.ts
│   └── validators.test.ts
├── integration/              # Integration tests
│   ├── db-operations.test.ts
│   └── tauri-commands.test.ts
└── e2e/                      # End-to-end tests (Playwright)
    ├── timer-flow.spec.ts
    ├── task-management.spec.ts
    └── settings.spec.ts
```

**Structure Decision**: Using Tauri hybrid architecture with clear separation:
- **Frontend (src/)**: Svelte 5 components following Shadcn-svelte patterns, organized by feature domains
- **Backend (src-tauri/)**: Rust code handling database, system integration, and Tauri commands
- **State Management**: Svelte stores for reactive state, services for business logic
- **Database**: SQLite with migration system, query layer abstraction

## Phase 0: Research & Integration

### Boilerplate Integration

1. **Clone and analyze boilerplate**
   - Repository: https://github.com/alysonhower/tauri2-svelte5-shadcn
   - Understand existing structure, build configs, dependencies
   - Document deviations needed for TomatoTask requirements

2. **Verify tooling setup**
   - Rust toolchain (cargo, rustc, clippy)
   - Node.js + pnpm/npm
   - Tauri CLI
   - TypeScript compiler
   - ESLint + Prettier configs

3. **Database design research**
   - SQLite schema design for tasks, projects, sessions, settings
   - Index strategy for performance (task queries, date ranges)
   - Migration strategy (rusqlite_migration or refinery)

4. **i18n framework selection**
   - Evaluate svelte-i18n vs alternatives
   - Translation file structure
   - Locale-aware formatting (dates, numbers)

5. **System integration research**
   - Tauri notification plugin API
   - System tray implementation (tauri-plugin-system-tray)
   - Audio notification approach (HTML5 Audio vs native)

## Phase 1: Core Architecture Setup

### 1.1 Database Schema & Migrations

**File**: `src-tauri/src/db/migrations.rs`

```sql
-- Migration 001: Initial schema
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    color TEXT,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    description TEXT,
    project_id INTEGER,
    estimated_pomodoros INTEGER DEFAULT 0,
    completed_pomodoros INTEGER DEFAULT 0,
    is_completed INTEGER DEFAULT 0, -- SQLite boolean (0/1)
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now')),
    completed_at TEXT,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE SET NULL
);

CREATE TABLE pomodoro_sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER,
    started_at TEXT NOT NULL,
    completed_at TEXT,
    duration_minutes INTEGER NOT NULL,
    session_type TEXT NOT NULL, -- 'work', 'short_break', 'long_break'
    interrupted INTEGER DEFAULT 0,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE SET NULL
);

CREATE TABLE settings (
    id INTEGER PRIMARY KEY CHECK (id = 1), -- Singleton
    work_duration INTEGER DEFAULT 25,
    short_break_duration INTEGER DEFAULT 5,
    long_break_duration INTEGER DEFAULT 15,
    pomodoros_until_long_break INTEGER DEFAULT 4,
    language TEXT DEFAULT 'en',
    theme TEXT DEFAULT 'light',
    notification_sound TEXT DEFAULT 'default',
    auto_start_breaks INTEGER DEFAULT 0,
    auto_start_pomodoros INTEGER DEFAULT 0,
    updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Indexes for performance
CREATE INDEX idx_tasks_project ON tasks(project_id);
CREATE INDEX idx_tasks_completed ON tasks(is_completed);
CREATE INDEX idx_sessions_task ON pomodoro_sessions(task_id);
CREATE INDEX idx_sessions_date ON pomodoro_sessions(started_at);

-- Insert default settings
INSERT INTO settings (id) VALUES (1);
```

### 1.2 Rust Type Definitions

**File**: `src-tauri/src/db/models.rs`

```rust
use serde::{Deserialize, Serialize};

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct Task {
    pub id: i64,
    pub title: String,
    pub description: Option<String>,
    pub project_id: Option<i64>,
    pub estimated_pomodoros: i32,
    pub completed_pomodoros: i32,
    pub is_completed: bool,
    pub created_at: String,
    pub updated_at: String,
    pub completed_at: Option<String>,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct CreateTaskInput {
    pub title: String,
    pub description: Option<String>,
    pub project_id: Option<i64>,
    pub estimated_pomodoros: i32,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct Project {
    pub id: i64,
    pub name: String,
    pub color: Option<String>,
    pub created_at: String,
    pub updated_at: String,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct PomodoroSession {
    pub id: i64,
    pub task_id: Option<i64>,
    pub started_at: String,
    pub completed_at: Option<String>,
    pub duration_minutes: i32,
    pub session_type: String,
    pub interrupted: bool,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct Settings {
    pub work_duration: i32,
    pub short_break_duration: i32,
    pub long_break_duration: i32,
    pub pomodoros_until_long_break: i32,
    pub language: String,
    pub theme: String,
    pub notification_sound: String,
    pub auto_start_breaks: bool,
    pub auto_start_pomodoros: bool,
}
```

### 1.3 TypeScript Type Definitions

**File**: `src/lib/types/task.ts`

```typescript
export interface Task {
  id: number;
  title: string;
  description?: string;
  projectId?: number;
  estimatedPomodoros: number;
  completedPomodoros: number;
  isCompleted: boolean;
  createdAt: string;
  updatedAt: string;
  completedAt?: string;
}

export interface CreateTaskInput {
  title: string;
  description?: string;
  projectId?: number;
  estimatedPomodoros: number;
}

export interface Project {
  id: number;
  name: string;
  color?: string;
  createdAt: string;
  updatedAt: string;
}

export interface PomodoroSession {
  id: number;
  taskId?: number;
  startedAt: string;
  completedAt?: string;
  durationMinutes: number;
  sessionType: 'work' | 'short_break' | 'long_break';
  interrupted: boolean;
}

export interface Settings {
  workDuration: number;
  shortBreakDuration: number;
  longBreakDuration: number;
  pomosorosUntilLongBreak: number;
  language: string;
  theme: 'light' | 'dark';
  notificationSound: string;
  autoStartBreaks: boolean;
  autoStartPomodoros: boolean;
}
```

### 1.4 Tauri Commands Interface

**Contract**: 15 core commands bridging frontend ↔ backend

1. **Task Commands** (`src-tauri/src/commands/tasks.rs`)
   - `get_tasks() -> Result<Vec<Task>>`
   - `get_task(id: i64) -> Result<Task>`
   - `create_task(input: CreateTaskInput) -> Result<Task>`
   - `update_task(id: i64, input: CreateTaskInput) -> Result<Task>`
   - `delete_task(id: i64) -> Result<()>`
   - `toggle_task_completion(id: i64) -> Result<Task>`

2. **Project Commands** (`src-tauri/src/commands/projects.rs`)
   - `get_projects() -> Result<Vec<Project>>`
   - `create_project(name: String, color: Option<String>) -> Result<Project>`
   - `delete_project(id: i64) -> Result<()>`

3. **Timer/Session Commands** (`src-tauri/src/commands/timer.rs`)
   - `create_session(task_id: Option<i64>, duration: i32, type: String) -> Result<PomodoroSession>`
   - `complete_session(id: i64) -> Result<PomodoroSession>`

4. **Settings Commands** (`src-tauri/src/commands/settings.rs`)
   - `get_settings() -> Result<Settings>`
   - `update_settings(settings: Settings) -> Result<Settings>`

5. **Summary Commands** (`src-tauri/src/commands/summary.rs`)
   - `get_daily_summary(date: String) -> Result<DailySummary>`
   - `get_weekly_summary(start_date: String) -> Result<Vec<DailySummary>>`

## Phase 2: Feature Implementation Priority

### P1: Core Timer & Tasks (MVP)

**User Stories**: US1 (Timer), US2 (Tasks)
**Components**: PomodoroTimer, TimerControls, TaskList, TaskForm
**Stores**: timer.ts, tasks.ts
**Commands**: Task commands, Timer commands, Settings commands (basic)
**Estimated**: 40% of total effort

### P2: Integration & Analytics

**User Stories**: US3 (Task-Pomodoro mapping), US4 (Summary)
**Components**: TaskCard (with progress), DailySummary, WeeklyChart
**Stores**: summary.ts
**Commands**: Summary commands
**Estimated**: 25% of total effort

### P3: Customization & i18n

**User Stories**: US5 (Settings), US6 (Languages), US10 (Keyboard)
**Components**: SettingsPanel, LanguageSelector
**Services**: i18n-service.ts, keyboard shortcuts
**i18n**: All 5 language translations
**Estimated**: 20% of total effort

### P4: Enhancement Features

**User Stories**: US7 (Theme), US8 (System Tray), US9 (Projects)
**Components**: ThemeToggle, project organization UI
**System Integration**: Tray plugin, notifications
**Estimated**: 15% of total effort

## Performance Strategy

### Frontend Optimization
- **Svelte reactivity**: Use `$derived` for computed values, avoid unnecessary `$effect`
- **Component lazy loading**: Dynamic imports for settings/summary views
- **Virtual scrolling**: For task lists exceeding 100 items
- **Debouncing**: 300ms debounce on search inputs

### Backend Optimization
- **Prepared statements**: Cache all SQL queries
- **Batch operations**: Bulk inserts for migrations
- **Indexes**: Already defined in schema on hot paths
- **Connection pooling**: Single connection reused (SQLite limitation)

### Bundle Optimization
- **Tree shaking**: Remove unused Shadcn components
- **CSS purging**: TailwindCSS purge unused classes
- **Asset optimization**: Compress notification sounds

## Testing Strategy

### Unit Tests (Vitest)
- `timer-service.ts`: Timer logic, state transitions
- `task-service.ts`: Task CRUD operations
- `validators.ts`: Input validation rules
- Target: 70%+ coverage

### Integration Tests
- Tauri command flows (invoke from frontend mock)
- Database operations (CRUD cycles)
- State synchronization (stores ↔ commands)

### E2E Tests (Playwright)
- **Critical Path 1**: Launch → Create task → Start Pomodoro → Complete → Verify task progress
- **Critical Path 2**: Create 5 tasks → Complete 3 → View summary → Verify counts
- **Critical Path 3**: Open settings → Change language → Change theme → Restart → Verify persistence

## Security Checklist

- ✅ All SQL queries use prepared statements (rusqlite params)
- ✅ Input validation on frontend (TypeScript validators.ts)
- ✅ Input validation on backend (Rust command parameter validation)
- ✅ XSS prevention (Svelte auto-escapes, no `@html` usage)
- ✅ Error messages sanitized (no internal paths/queries exposed)
- ✅ File permissions (SQLite DB file user-only read/write)

## Accessibility Checklist

- ✅ Semantic HTML (buttons, forms, headings)
- ✅ ARIA labels on all interactive elements
- ✅ Keyboard navigation (Tab order, focus management)
- ✅ Focus indicators (visible outlines, TailwindCSS ring utilities)
- ✅ Contrast ratios (4.5:1 minimum, verified with tooling)
- ✅ Screen reader testing (test with NVDA/JAWS)

## Complexity Tracking

No constitutional violations requiring justification.

## Next Steps

1. ✅ **Constitution defined** (v1.0.0)
2. ✅ **Specifications complete** (10 user stories, 40 FRs, 15 success criteria)
3. ✅ **Implementation plan complete** (this document)
4. ⏭️ **Generate tasks** (run `/speckit.tasks` to break down into actionable items)
5. ⏭️ **Clone boilerplate** (integrate Tauri2-Svelte5-Shadcn base)
6. ⏭️ **Implement P1 features** (MVP: Timer + Tasks)
7. ⏭️ **Iterate P2-P4** (Progressive enhancement)

---

**Plan Status**: ✅ Complete and ready for task generation
**Next Command**: `/speckit.tasks` to generate implementation tasks
**Estimated Total Effort**: 80-120 hours (2-3 weeks full-time development)
